<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Group Viewer</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    
    h1 {
      margin-bottom: 20px;
      color: #333;
    }
    
    .controls {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .controls input[type="file"] {
      padding: 10px;
    }
    
    .controls button {
      padding: 10px 20px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .controls button:hover {
      background: #3367d6;
    }
    
    .controls button.save {
      background: #34a853;
    }
    
    .controls button.save:hover {
      background: #2d8e47;
    }
    
    .controls select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      background: white;
    }
    
    .controls select:hover {
      border-color: #4285f4;
    }
    
    .filter-buttons {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }
    
    .filter-buttons button {
      padding: 8px 16px;
      border: 2px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .filter-buttons button.active {
      border-color: #4285f4;
      background: #e8f0fe;
    }
    
    .filter-buttons button.replaced {
      border-color: #34a853;
    }
    
    .filter-buttons button.not-replaced {
      border-color: #ea4335;
    }
    
    .stats {
      margin-bottom: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stats span {
      margin-right: 20px;
    }
    
    .unsaved-changes {
      background: #fef7e0;
      color: #f9a825;
      padding: 10px 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }
    
    .unsaved-changes.show {
      display: block;
    }
    
    .group {
      background: white;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .group-header {
      padding: 15px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    
    .group-header:hover {
      background: #f8f9fa;
    }
    
    .group-header.replaced {
      border-left: 5px solid #34a853;
    }
    
    .group-header.not-replaced {
      border-left: 5px solid #ea4335;
    }
    
    .group-header .left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .group-header .arrow {
      transition: transform 0.3s;
      font-size: 12px;
    }
    
    .group-header.open .arrow {
      transform: rotate(90deg);
    }
    
    .group-header .group-id {
      font-weight: bold;
      color: #333;
    }
    
    .group-header .status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .group-header .status:hover {
      transform: scale(1.05);
    }
    
    .group-header .status.replaced {
      background: #e6f4ea;
      color: #34a853;
    }
    
    .group-header .status.not-replaced {
      background: #fce8e6;
      color: #ea4335;
    }
    
    .group-header .job-name {
      color: #666;
    }
    
    .group-header .count {
      background: #e8f0fe;
      color: #4285f4;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
    }
    
    .group-header .group-address {
      color: #666;
      font-size: 13px;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .group-header .years-badge {
      background: #fef7e0;
      color: #f9a825;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .group-header .right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .delete-btn {
      background: #ea4335;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
    }
    
    .delete-btn:hover {
      background: #c5221f;
    }
    
    .delete-group-btn {
      background: transparent;
      color: #ea4335;
      border: 1px solid #ea4335;
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
    }
    
    .delete-group-btn:hover {
      background: #fce8e6;
    }
    
    .group-content {
      display: none;
      border-top: 1px solid #eee;
    }
    
    .group-content.open {
      display: block;
    }
    
    .group-content table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .group-content th {
      background: #f8f9fa;
      padding: 12px 15px;
      text-align: left;
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
    }
    
    .group-content td {
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }
    
    .group-content tr:last-child td {
      border-bottom: none;
    }
    
    .group-content tr:hover {
      background: #f8f9fa;
    }
    
    .group-content a {
      color: #4285f4;
      text-decoration: none;
    }
    
    .group-content a:hover {
      text-decoration: underline;
    }
    
    .group-content input[type="text"],
    .group-content select {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .group-content input[type="text"]:focus,
    .group-content select:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
    }
    
    .group-content input.edited {
      background: #fff8e1;
    }
    
    .address {
      min-width: 200px;
    }
    
    .no-data {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .notes-field {
      min-width: 150px;
    }
    
    .toggle-status {
      padding: 4px 10px;
      font-size: 11px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
    }
    
    .toggle-status.to-replaced {
      background: #34a853;
      color: white;
    }
    
    .toggle-status.to-not-replaced {
      background: #ea4335;
      color: white;
    }
    
    /* Trade Types Styles */
    .trade-types-cell {
      min-width: 200px;
    }
    
    .trade-types-display {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 5px;
    }
    
    .trade-tag {
      background: #e8f0fe;
      color: #4285f4;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      white-space: nowrap;
    }
    
    .trade-tag.replace {
      background: #e6f4ea;
      color: #34a853;
      font-weight: bold;
    }
    
    .multi-select-container {
      position: relative;
    }
    
    .multi-select-button {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-size: 12px;
      color: #666;
      width: 100%;
      text-align: left;
    }
    
    .multi-select-button:hover {
      border-color: #4285f4;
    }
    
    .multi-select-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      max-height: 250px;
      overflow-y: auto;
    }
    
    .multi-select-dropdown.open {
      display: block;
    }
    
    .multi-select-search {
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    
    .multi-select-search input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .multi-select-option {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .multi-select-option:hover {
      background: #f5f5f5;
    }
    
    .multi-select-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    
    .multi-select-option.hidden {
      display: none;
    }
    
    .multi-select-option label {
      cursor: pointer;
      flex: 1;
    }
  </style>
</head>
<body>
  <h1>Geo Duplicates Group Viewer</h1>
  
  <div class="controls">
    <input type="file" id="csvFile" accept=".csv">
    <button onclick="expandAll()">Expand All</button>
    <button onclick="collapseAll()">Collapse All</button>
    <select id="sortSelect" onchange="sortGroups(this.value)">
      <option value="group-id-asc">Sort by: Group ID</option>
      <option value="years-asc">Years (Newest First)</option>
      <option value="years-desc">Years (Oldest First)</option>
      <option value="status-not-replaced">Status (Not Replaced First)</option>
      <option value="status-replaced">Status (Replaced First)</option>
      <option value="address-asc">Address (A-Z)</option>
      <option value="address-desc">Address (Z-A)</option>
      <option value="jobs-desc">Most Jobs First</option>
      <option value="jobs-asc">Fewest Jobs First</option>
    </select>
    <button class="save" onclick="exportAndSave()">Export and Save</button>
  </div>
  
  <div class="unsaved-changes" id="unsavedBanner">
    ⚠️ You have unsaved changes. Click "Export CSV" to save.
  </div>
  
  <div class="filter-buttons">
    <button class="active" onclick="filterGroups('all', this)">All Groups</button>
    <button class="not-replaced" onclick="filterGroups('NOT REPLACED', this)">Not Replaced</button>
    <button class="replaced" onclick="filterGroups('REPLACED', this)">Replaced</button>
  </div>
  
  <div class="stats" id="stats"></div>
  
  <div id="groups">
    <div class="no-data">Upload a CSV file to view groups</div>
  </div>

  <script>
    let allData = [];
    let groupedData = {};
    let headers = [];
    let hasChanges = false;
    let currentFilter = 'all';
    let currentSort = 'group-id-asc';
    let allTradeTypes = []; // Master list of all trade types
    
    document.getElementById('csvFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          parseCSV(e.target.result);
        };
        reader.readAsText(file);
      }
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.multi-select-container')) {
        document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('open'));
      }
    });
    
    function parseCSV(csv) {
      const lines = csv.split('\n');
      headers = parseCSVLine(lines[0]).map(h => h.trim());
      
      // Add notes column if it doesn't exist
      if (!headers.includes('notes')) {
        headers.push('notes');
      }
      
      // Add last_edited column if it doesn't exist
      if (!headers.includes('last_edited')) {
        headers.push('last_edited');
      }
      
      allData = [];
      const tradeTypeSet = new Set();
      
      for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim() === '') continue;
        const values = parseCSVLine(lines[i]);
        const row = {};
        headers.forEach((header, index) => {
          row[header] = values[index] ? values[index].trim() : '';
        });
        
        // Parse trade types and collect unique ones
        const tradeTypes = parseTradeTypes(row['out_trade_types']);
        row._parsedTradeTypes = tradeTypes;
        tradeTypes.forEach(t => tradeTypeSet.add(t.name));
        
        allData.push(row);
      }
      
      // Build master list of trade types sorted alphabetically
      allTradeTypes = Array.from(tradeTypeSet).sort();
      
      groupData();
      renderGroups(currentFilter);
      hasChanges = false;
      updateUnsavedBanner();
    }
    
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);
      return result;
    }
    
    function parseTradeTypes(jsonStr) {
      if (!jsonStr || jsonStr === '[]') return [];
      try {
        const parsed = JSON.parse(jsonStr);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        // Try fixing common JSON issues from CSV
        try {
          const fixed = jsonStr.replace(/""/g, '"');
          const parsed = JSON.parse(fixed);
          return Array.isArray(parsed) ? parsed : [];
        } catch (e2) {
          console.log('Failed to parse trade types:', jsonStr);
          return [];
        }
      }
    }
    
    function groupData() {
      groupedData = {};
      
      allData.forEach((row, index) => {
        // Skip deleted rows
        if (row._deleted) return;
        
        row._originalIndex = index;
        const groupId = row['out_group_id'];
        if (!groupedData[groupId]) {
          groupedData[groupId] = [];
        }
        groupedData[groupId].push(row);
      });
      
      // Remove empty groups (all rows deleted)
      Object.keys(groupedData).forEach(groupId => {
        if (groupedData[groupId].length === 0) {
          delete groupedData[groupId];
        }
      });
      
      // Sort each group by date descending
      Object.keys(groupedData).forEach(groupId => {
        groupedData[groupId].sort((a, b) => {
          return new Date(b['out_created_date']) - new Date(a['out_created_date']);
        });
      });
    }
    
    function toggleGroupStatus(groupId, event) {
      event.stopPropagation();
      
      const rows = groupedData[groupId];
      const currentStatus = rows[0]['out_group_status'];
      const newStatus = currentStatus === 'REPLACED' ? 'NOT REPLACED' : 'REPLACED';
      const timestamp = new Date().toISOString();
      
      rows.forEach(row => {
        row['out_group_status'] = newStatus;
        row['last_edited'] = timestamp;
        row._editedThisSession = true;
        allData[row._originalIndex]['out_group_status'] = newStatus;
        allData[row._originalIndex]['last_edited'] = timestamp;
        allData[row._originalIndex]._editedThisSession = true;
      });
      
      hasChanges = true;
      updateUnsavedBanner();
      
      groupData();
      renderGroups(currentFilter);
    }
    
    function renderTradeTypeTags(tradeTypes) {
      if (!tradeTypes || tradeTypes.length === 0) {
        return '<span style="color: #999; font-size: 12px;">No trade types</span>';
      }
      
      return tradeTypes.map(t => {
        const isReplace = t.name.toLowerCase().includes('replace');
        return `<span class="trade-tag ${isReplace ? 'replace' : ''}">${escapeHtml(t.name)}</span>`;
      }).join('');
    }
    
    function sortGroups(sortBy) {
      currentSort = sortBy;
      renderGroups(currentFilter);
    }
    
    function getGroupSortData(groupId) {
      const rows = groupedData[groupId];
      const status = rows[0]['out_group_status'] || '';
      const address = rows.find(r => r['address'])?.['address'] || '';
      const yearsValues = rows
        .map(r => parseFloat(r['out_years_since_created']))
        .filter(y => !isNaN(y));
      const smallestYears = yearsValues.length > 0 ? Math.min(...yearsValues) : 999;
      const jobCount = rows.length;
      
      return { status, address, smallestYears, jobCount };
    }
    
    function renderGroups(filter) {
      currentFilter = filter;
      const container = document.getElementById('groups');
      container.innerHTML = '';
      
      let totalGroups = 0;
      let replacedCount = 0;
      let notReplacedCount = 0;
      
      let sortedGroupIds = Object.keys(groupedData);
      
      // Apply sorting
      sortedGroupIds.sort((a, b) => {
        const dataA = getGroupSortData(a);
        const dataB = getGroupSortData(b);
        
        switch (currentSort) {
          case 'group-id-asc':
            return parseInt(a) - parseInt(b);
          case 'years-asc':
            return dataA.smallestYears - dataB.smallestYears;
          case 'years-desc':
            return dataB.smallestYears - dataA.smallestYears;
          case 'status-not-replaced':
            if (dataA.status === dataB.status) return parseInt(a) - parseInt(b);
            return dataA.status === 'NOT REPLACED' ? -1 : 1;
          case 'status-replaced':
            if (dataA.status === dataB.status) return parseInt(a) - parseInt(b);
            return dataA.status === 'REPLACED' ? -1 : 1;
          case 'address-asc':
            return dataA.address.localeCompare(dataB.address);
          case 'address-desc':
            return dataB.address.localeCompare(dataA.address);
          case 'jobs-desc':
            return dataB.jobCount - dataA.jobCount;
          case 'jobs-asc':
            return dataA.jobCount - dataB.jobCount;
          default:
            return parseInt(a) - parseInt(b);
        }
      });
      
      sortedGroupIds.forEach(groupId => {
        const rows = groupedData[groupId];
        const latestRow = rows[0];
        const status = latestRow['out_group_status'] || '';
        
        if (status === 'REPLACED') replacedCount++;
        if (status === 'NOT REPLACED') notReplacedCount++;
        totalGroups++;
        
        if (filter !== 'all' && status !== filter) return;
        
        const group = document.createElement('div');
        group.className = 'group';
        group.dataset.status = status;
        group.dataset.groupId = groupId;
        
        const statusClass = status === 'REPLACED' ? 'replaced' : 'not-replaced';
        const toggleButtonClass = status === 'REPLACED' ? 'to-not-replaced' : 'to-replaced';
        const toggleButtonText = status === 'REPLACED' ? 'Mark Not Replaced' : 'Mark Replaced';
        
        // Find address (use first non-empty address in group)
        const groupAddress = rows.find(r => r['address'])?.['address'] || 'No address';
        
        // Find smallest years (newest job - least time since created)
        const yearsValues = rows
          .map(r => parseFloat(r['out_years_since_created']))
          .filter(y => !isNaN(y));
        const smallestYears = yearsValues.length > 0 ? Math.min(...yearsValues) : 'N/A';
        
        group.innerHTML = `
          <div class="group-header ${statusClass}" onclick="toggleGroup(this)">
            <div class="left">
              <span class="arrow">▶</span>
              <span class="group-id">Group ${groupId}</span>
              <span class="status ${statusClass}" onclick="toggleGroupStatus('${groupId}', event)" title="Click to toggle status">${status}</span>
              <button class="toggle-status ${toggleButtonClass}" onclick="toggleGroupStatus('${groupId}', event)">${toggleButtonText}</button>
              <span class="job-name">${latestRow['out_job_name'] || ''}</span>
            </div>
            <div class="right">
              <span class="group-address" title="${escapeHtml(groupAddress)}">${escapeHtml(groupAddress.length > 40 ? groupAddress.substring(0, 40) + '...' : groupAddress)}</span>
              <span class="years-badge">${smallestYears} yrs</span>
              <span class="count">${rows.length} job${rows.length > 1 ? 's' : ''}</span>
              <button class="delete-group-btn" onclick="deleteGroup('${groupId}', event)">Delete Group</button>
            </div>
          </div>
          <div class="group-content">
            <table>
              <thead>
                <tr>
                  <th>Job Name</th>
                  <th>Milestone</th>
                  <th>Trade Types</th>
                  <th>Date</th>
                  <th>Years</th>
                  <th>Address</th>
                  <th>State</th>
                  <th>Notes</th>
                  <th>Link</th>
                  <th>Delete</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map(row => `
                  <tr data-index="${row._originalIndex}">
                    <td>
                      <input type="text" value="${escapeHtml(row['out_job_name'] || '')}" 
                             onchange="updateValue(${row._originalIndex}, 'out_job_name', this.value, this)">
                    </td>
                    <td>
                      <select onchange="updateValue(${row._originalIndex}, 'out_current_milestone', this.value, this)">
                        <option value="">--</option>
                        <option value="Lead" ${row['out_current_milestone'] === 'Lead' ? 'selected' : ''}>Lead</option>
                        <option value="Appointment" ${row['out_current_milestone'] === 'Appointment' ? 'selected' : ''}>Appointment</option>
                        <option value="Approved" ${row['out_current_milestone'] === 'Approved' ? 'selected' : ''}>Approved</option>
                        <option value="Completed" ${row['out_current_milestone'] === 'Completed' ? 'selected' : ''}>Completed</option>
                        <option value="Invoiced" ${row['out_current_milestone'] === 'Invoiced' ? 'selected' : ''}>Invoiced</option>
                        <option value="Closed" ${row['out_current_milestone'] === 'Closed' ? 'selected' : ''}>Closed</option>
                        <option value="Cancelled" ${row['out_current_milestone'] === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        <option value="Lost" ${row['out_current_milestone'] === 'Lost' ? 'selected' : ''}>Lost</option>
                      </select>
                    </td>
                    <td class="trade-types-cell">
                      <div class="trade-types-display">
                        ${renderTradeTypeTags(row._parsedTradeTypes)}
                      </div>
                      <div class="multi-select-container">
                        <button class="multi-select-button" onclick="toggleDropdown(event, ${row._originalIndex})">
                          Edit Trade Types ▼
                        </button>
                        <div class="multi-select-dropdown" id="dropdown-${row._originalIndex}">
                          <div class="multi-select-search">
                            <input type="text" placeholder="Search trade types..." oninput="filterTradeOptions(${row._originalIndex}, this.value)">
                          </div>
                          ${renderTradeTypeOptions(row._originalIndex, row._parsedTradeTypes)}
                        </div>
                      </div>
                    </td>
                    <td>${formatDate(row['out_created_date'])}</td>
                    <td>${row['out_years_since_created'] || ''}</td>
                    <td class="address">
                      <input type="text" value="${escapeHtml(row['address'] || '')}" 
                             onchange="updateValue(${row._originalIndex}, 'address', this.value, this)">
                    </td>
                    <td>
                      <input type="text" value="${escapeHtml(row['State'] || '')}" 
                             onchange="updateValue(${row._originalIndex}, 'State', this.value, this)" 
                             style="width: 60px;">
                    </td>
                    <td class="notes-field">
                      <input type="text" value="${escapeHtml(row['notes'] || '')}" 
                             onchange="updateValue(${row._originalIndex}, 'notes', this.value, this)"
                             placeholder="Add notes...">
                    </td>
                    <td>${row['URL'] ? `<a href="${row['URL']}" target="_blank">Open</a>` : ''}</td>
                    <td><button class="delete-btn" onclick="deleteRow(${row._originalIndex}, '${groupId}')">Delete</button></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        container.appendChild(group);
      });
      
      document.getElementById('stats').innerHTML = `
        <span><strong>Total Groups:</strong> ${totalGroups}</span>
        <span style="color: #34a853;"><strong>Replaced:</strong> ${replacedCount}</span>
        <span style="color: #ea4335;"><strong>Not Replaced:</strong> ${notReplacedCount}</span>
      `;
    }
    
    function renderTradeTypeOptions(rowIndex, selectedTypes) {
      const selectedNames = selectedTypes.map(t => t.name);
      
      return allTradeTypes.map(name => {
        const isChecked = selectedNames.includes(name);
        const escapedName = escapeHtml(name);
        return `
          <div class="multi-select-option" data-name="${escapedName.toLowerCase()}">
            <input type="checkbox" id="trade-${rowIndex}-${escapedName}" 
                   ${isChecked ? 'checked' : ''} 
                   onchange="toggleTradeType(${rowIndex}, '${escapedName.replace(/'/g, "\\'")}', this.checked)">
            <label for="trade-${rowIndex}-${escapedName}">${escapedName}</label>
          </div>
        `;
      }).join('');
    }
    
    function toggleDropdown(event, rowIndex) {
      event.stopPropagation();
      const dropdown = document.getElementById(`dropdown-${rowIndex}`);
      
      // Close all other dropdowns
      document.querySelectorAll('.multi-select-dropdown').forEach(d => {
        if (d.id !== `dropdown-${rowIndex}`) {
          d.classList.remove('open');
        }
      });
      
      dropdown.classList.toggle('open');
    }
    
    function filterTradeOptions(rowIndex, searchTerm) {
      const dropdown = document.getElementById(`dropdown-${rowIndex}`);
      const options = dropdown.querySelectorAll('.multi-select-option');
      const term = searchTerm.toLowerCase();
      
      options.forEach(option => {
        const name = option.dataset.name;
        if (name.includes(term)) {
          option.classList.remove('hidden');
        } else {
          option.classList.add('hidden');
        }
      });
    }
    
    function toggleTradeType(rowIndex, tradeName, isChecked) {
      const row = allData[rowIndex];
      let tradeTypes = row._parsedTradeTypes || [];
      
      if (isChecked) {
        // Add trade type
        if (!tradeTypes.find(t => t.name === tradeName)) {
          // Generate a simple ID for new trade types
          tradeTypes.push({
            id: 'new-' + Date.now(),
            name: tradeName
          });
        }
      } else {
        // Remove trade type
        tradeTypes = tradeTypes.filter(t => t.name !== tradeName);
      }
      
      row._parsedTradeTypes = tradeTypes;
      row['out_trade_types'] = JSON.stringify(tradeTypes);
      row['last_edited'] = new Date().toISOString();
      row._editedThisSession = true;
      
      // Update the display
      const tradeDisplay = document.querySelector(`tr[data-index="${rowIndex}"] .trade-types-display`);
      if (tradeDisplay) {
        tradeDisplay.innerHTML = renderTradeTypeTags(tradeTypes);
      }
      
      hasChanges = true;
      updateUnsavedBanner();
    }
    
    function deleteRow(rowIndex, groupId) {
      if (!confirm('Are you sure you want to delete this row?')) return;
      
      // Mark row as deleted
      allData[rowIndex]._deleted = true;
      allData[rowIndex]['last_edited'] = new Date().toISOString();
      allData[rowIndex]._editedThisSession = true;
      
      hasChanges = true;
      updateUnsavedBanner();
      
      // Re-group and re-render
      groupData();
      renderGroups(currentFilter);
    }
    
    function deleteGroup(groupId, event) {
      event.stopPropagation();
      
      const rows = groupedData[groupId];
      if (!confirm(`Are you sure you want to delete this entire group? (${rows.length} jobs)`)) return;
      
      const timestamp = new Date().toISOString();
      
      // Mark all rows in group as deleted
      rows.forEach(row => {
        allData[row._originalIndex]._deleted = true;
        allData[row._originalIndex]['last_edited'] = timestamp;
        allData[row._originalIndex]._editedThisSession = true;
      });
      
      hasChanges = true;
      updateUnsavedBanner();
      
      // Re-group and re-render
      groupData();
      renderGroups(currentFilter);
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/"/g, '&quot;');
    }
    
    function updateValue(index, field, value, element) {
      allData[index][field] = value;
      allData[index]['last_edited'] = new Date().toISOString();
      allData[index]._editedThisSession = true;
      if (element) element.classList.add('edited');
      hasChanges = true;
      updateUnsavedBanner();
    }
    
    function updateUnsavedBanner() {
      const banner = document.getElementById('unsavedBanner');
      if (hasChanges) {
        banner.classList.add('show');
      } else {
        banner.classList.remove('show');
      }
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      if (isNaN(date)) return dateStr;
      return date.toLocaleDateString();
    }
    
    function toggleGroup(header) {
      header.classList.toggle('open');
      header.nextElementSibling.classList.toggle('open');
    }
    
    function expandAll() {
      document.querySelectorAll('.group-header').forEach(header => {
        header.classList.add('open');
        header.nextElementSibling.classList.add('open');
      });
    }
    
    function collapseAll() {
      document.querySelectorAll('.group-header').forEach(header => {
        header.classList.remove('open');
        header.nextElementSibling.classList.remove('open');
      });
    }
    
    function filterGroups(filter, button) {
      document.querySelectorAll('.filter-buttons button').forEach(btn => {
        btn.classList.remove('active');
      });
      button.classList.add('active');
      renderGroups(filter);
    }
    
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzBhXSmBzzZmxK91Vyj_hVsjlBQWkKxyp1jJPtwOK7U_SBdQUZIIkd0b0Bu40zPw24D/exec';
    
    function exportAndSave() {
      if (allData.length === 0) {
        alert('No data to export');
        return;
      }
      
      // Filter out deleted rows for full export
      const exportDataAll = allData.filter(row => !row._deleted);
      
      if (exportDataAll.length === 0) {
        alert('No data to export (all rows deleted)');
        return;
      }
      
      // Filter to only edited rows
      const exportDataEdited = allData.filter(row => !row._deleted && row._editedThisSession);
      
      // Build full CSV
      let csvAll = headers.map(h => `"${h}"`).join(',') + '\n';
      exportDataAll.forEach(row => {
        const values = headers.map(header => {
          let val = row[header] || '';
          val = val.toString().replace(/"/g, '""');
          return `"${val}"`;
        });
        csvAll += values.join(',') + '\n';
      });
      
      // Build edited-only CSV
      let csvEdited = '';
      if (exportDataEdited.length > 0) {
        csvEdited = headers.map(h => `"${h}"`).join(',') + '\n';
        exportDataEdited.forEach(row => {
          const values = headers.map(header => {
            let val = row[header] || '';
            val = val.toString().replace(/"/g, '""');
            return `"${val}"`;
          });
          csvEdited += values.join(',') + '\n';
        });
      }
      
      // Download full CSV
      downloadCSV(csvAll, 'geo_duplicates_full.csv');
      
      // Download edited CSV if there are edited rows
      if (exportDataEdited.length > 0) {
        setTimeout(() => {
          downloadCSV(csvEdited, 'geo_duplicates_edited.csv');
        }, 500);
      }
      
      // Send email via Google Apps Script
      sendEmail(csvAll, csvEdited, exportDataEdited.length);
      
      hasChanges = false;
      updateUnsavedBanner();
      
      document.querySelectorAll('.edited').forEach(el => {
        el.classList.remove('edited');
      });
    }
    
    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    function sendEmail(csvAll, csvEdited, editedCount) {
      const data = {
        csvAll: csvAll,
        csvEdited: csvEdited,
        editedCount: editedCount
      };
      
      fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(() => {
        console.log('Email request sent');
      })
      .catch(error => {
        console.error('Error sending email:', error);
      });
    }
    
    window.addEventListener('beforeunload', function(e) {
      if (hasChanges) {
        e.preventDefault();
        e.returnValue = '';
      }
    });
  </script>
</body>
</html>
